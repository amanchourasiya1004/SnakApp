{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Muli" />
    <link rel="stylesheet" href="{% static 'css/personalchat.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src='https://kit.fontawesome.com/a076d05399.js'></script>
    <title>GroupChat</title>
</head>
<body>
    <nav class="navbar bg-custom navbar-expand-xs fixed-top navbar-default">
        <div class="hamburger d-flex">
            <i class="fa fa-arrow-left" aria-hidden="true"></i>
            <span class="user-icon">
                <img class="rounded-circle" src="{% static 'images/user-profile/avatar-dhg.png' %}">
            </span>
            <div class="brand">{{groupname}}</div>
        </div>
        
            <div class="headicons">
                <div class="dropdown">

                    <i class="fa fa-ellipsis-v" data-toggle = 'dropdown' aria-haspopup="true" aria-expanded="false"></i>
                    <div class="dropdown-menu dropdown-menu-right">
                        <button class="dropdown-item participants" type="button" >Participants</button>
                        <button class="dropdown-item groupinfo" type="button" >Group Info</button>
                    </div>
                </div>
            </div>
    </nav>
    <div class="message-store">
        <div class="msg-input-div">
            <div class="msg-send-box">
                <div class="emoji">
                    <i class='far fa-grin' style='font-size:24px'></i>
                </div>
                <div style="display: inline-block; width: 80%;">
                    <input type="text" class="msg-send" placeholder="Type here..." id = "msg-input">
                </div>
                
                <form action = "{%url 'GroupView' groupname %}" id = "imageformupload" method="POST" enctype="multipart/form-data" class="imageform">
                    {% csrf_token %}
                    <label for="imagesent">
                        <i class="fas fa-camera icons"></i>        
                    </label>
                    <input type='file' id="imagesent" accept="image/*" name = "image" class="imageupload"/>
                </form>
                <i class="fa fa-paper-plane icons" aria-hidden="true" id = "msg-submit"></i>
            </div>
        </div>
        
        <div class="message-body" id = "msg-body">
            {% if len == 0 %}
                <div></div>
            {% else %}
                {% for i in chats %}
                    {% if i.sender.username == request.user.username %}
                        {% if i.msgtype == 1 %}
                            <div class="message-wrap-three-dots-user d-flex flex-row-reverse">
                                <div class="message-wrap-with-icon-user d-flex flex-row-reverse">
                                    <div class="message-wrap-user">
                                        {{i.chats}}
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="message-wrap-three-dots-user d-flex flex-row-reverse">
                                <div class="message-wrap-with-icon-user d-flex flex-row-reverse">
                                    <div class="image-wrap-user d-flex flex-row-reverse">
                                        <div class="imagemsg">
                                            <img src="{{i.path_image}}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% else %}
                        {% if i.msgtype == 1 %}
                            <div class="message-wrap-three-dots">
                                <div class="message-wrap-with-icon">
                                    <div class="message-wrap">
                                        {{i.chats}}
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="message-wrap-three-dots">
                                <div class="message-wrap-with-icon">
                                    <div class="image-wrap">
                                        <div class="imagemsg">
                                            <img src="{{i.path_image}}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>    
    <script>
        $(document).ready(function(){
            const groupname = "{{groupname|escapejs}}"
            $(".fa-arrow-left").click(function(){
                window.location.pathname = '/main/';
            })
            $(".participants").click(function(){
                window.location.pathname = '/groups/' + groupname + '/participants/';
            })
            $(".groupinfo").click(function(){
                window.location.pathname = '/groups/' + groupname + '/info/';
            })
            var i = 0;
            var me = "{{user|escapejs}}"
            var msgbox = $(".message-body");
            const socket = new WebSocket("ws://" + window.location.host + "/ws/chat/" + groupname + "/");
            var username = "{{user|escapejs}}"
            socket.onmessage = function(e){
                const data = JSON.parse(e.data);
                
                if(data.msg_type === 1){
                    if(data.sender == me){
                        msgbox.append(
                            '<div class="message-wrap-three-dots-user d-flex flex-row-reverse"><div class="message-wrap-with-icon-user d-flex flex-row-reverse"><div class="message-wrap-user">' + data.message + '</div></div></div>'
                        );
                    }
                    else{
                        msgbox.append(
                            '<div class="message-wrap-three-dots"><div class="message-wrap-with-icon"><div class="message-wrap">' + data.message + '</div></div></div>'
                        );
                    }
                    var box = document.getElementById("msg-body");
                    box.scrollTop = msgbox.scrollHeight;
                }
                else{
                    if(data.sender == me){
                        msgbox.append(
                            '<div class="message-wrap-three-dots-user d-flex flex-row-reverse"><div class="message-wrap-with-icon-user d-flex flex-row-reverse"><div class="image-wrap-user d-flex flex-row-reverse"><div class="imagemsg"><img src="#" class="imageuploaded" ></div></div></div></div>'
                        );
                        $($(".imageuploaded")[i]).attr('src', data.message);
                        i++;
                    }
                    else{
                        msgbox.append(
                            '<div class="message-wrap-three-dots"><div class="message-wrap-with-icon"><div class="image-wrap"><div class="imagemsg"><img src="#" class="imageuploaded" ></div></div></div></div>'
                        );
                        $($(".imageuploaded")[i]).attr('src', data.message);
                        i++;
                    }
                    var box = document.getElementById("msg-body");
                    box.scrollTop = msgbox.scrollHeight;
                }
            }
            socket.onclose = function(e){
                console.error("Chat Socket closed unexpectedly");
            }

            $("#msg-input").focus();
            $("#msg-input").keyup(function(e){
                if(e.keyCode === 13){
                    $("#msg-submit").click();
                }
            });
            $("#msg-submit").click(function(e){
                const messageDOM = $("#msg-input");
                const message = messageDOM.val();
                
                socket.send(JSON.stringify({
                    'message' : message,
                    'type' : 1
                }));
                messageDOM.val('');
            });
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                        // Only send the token to relative URLs i.e. locally.
                        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                    }
                }
            });
            var sendimage;
            $('input[type="file"]').change(function(e){
                var file = e.target.files;
                sendimage = file[0];
                console.log(sendimage)
                if (file && file[0]) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        // $(".message-body").append(
                        //     '<div class="message-wrap-three-dots-user d-flex flex-row-reverse"><div class="message-wrap-with-icon-user d-flex flex-row-reverse"><div class="image-wrap-user d-flex flex-row-reverse"><div class="imagemsg"><img src="#" class="imageuploaded" ></div></div></div></div>'
                        // );
                        // $($(".imageuploaded")[i]).attr('src', e.target.result);
                        // i++;
                        console.log("yo")
                        $("#imageformupload").submit();
                    }
                    reader.readAsDataURL(file[0]);
                }
            });
            var submitHandler = function(event) {
                event.preventDefault();
                var form_data = new FormData();
                form_data.append('data', sendimage);

                for (var key of form_data.entries()) {
                    console.log(key[0] + ', ' + key[1]);
                }
                $.ajax({
                    url: "{% url 'GroupView' groupname %}",
                    type: 'POST',
                    data: form_data,
                    contentType: false,
                    processData: false,
                    cache : false,
                    success: function (response) {
                        console.log(response)
                        if(response.error){
                            console.log("Something wrong in view");
                        }
                        else{
                            socket.send(JSON.stringify({
                                'message' : response.path,
                                'type' : 0
                            }));
                        }
                    },
                    error: function(){
                        console.log("something bad happened");
                    },
                    cache: false
                    
                });
            };

        $(document).on('submit','#imageformupload', submitHandler);
        });
    </script>
</body>
</html>